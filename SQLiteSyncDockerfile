# Stage 1: Build sqlite3_rsync
FROM alpine:3.20 AS rsyncbuilder

# Install build dependencies
RUN apk add --no-cache build-base wget unzip

# Set SQLite version (check https://sqlite.org/download.html for latest)
ENV SQLITE_VERSION=3450000

# Download SQLite source (amalgamation form)
WORKDIR /tmp
RUN wget https://sqlite.org/2025/sqlite-src-${SQLITE_VERSION}.zip \
    && unzip sqlite-src-${SQLITE_VERSION}.zip

# Build sqlite3_rsync
WORKDIR /tmp/sqlite-src-${SQLITE_VERSION}/tool
RUN gcc -O2 -o sqlite3_rsync sqlite3_rsync.c ../sqlite3.c -lpthread -ldl

# Stage 2: Minimal runtime image
FROM alpine:3.20

# Install runtime dependencies for SQLite
RUN apk add --no-cache libstdc++ bash openssh

# Copy the built binary
COPY --from=rsyncbuilder /tmp/sqlite-src-*/tool/sqlite3_rsync /usr/local/bin/sqlite3_rsync

# Verify installation
RUN sqlite3_rsync --help || true

# Default command
ENTRYPOINT ["sqlite3_rsync"]
